<link rel="import" href="../../components/polymer/polymer.html">

<link rel="import" href="../../components/core-ajax/core-ajax.html">


<polymer-element name="tt-crud-server" hidden attributes="entityid data index">
  <template>

    <core-ajax id="service_get" url="/s/{{index}}/{{entityid}}" handleAs="json"
               contentType="application/json"
               response="{{data}}"
               method="GET"
               on-core-error="{{handleGetError}}"
               on-core-response="{{handleGetResponse}}">
    </core-ajax>
    <core-ajax id="service_save" url="/s/{{index}}/{{entityid}}" handleAs="json"
               contentType="application/json"
               body="{{dataToSaveString}}"
               method="{{serviceSaveVerb}}"
               on-core-error="{{handleSaveError}}"
               on-core-response="{{handleSaveResponse}}">
    </core-ajax>
    <core-ajax id="service_delete" url="/s/{{index}}/{{entityid}}" handleAs="json"
               contentType="application/json"
               body="{{dataToDeleteString}}"
               method="DELETE"
               on-core-error="{{handleDeleteError}}"
               on-core-response="{{handleDeleteResponse}}">
    </core-ajax>

  </template>

  <script>
    'use strict';
    Polymer('tt-crud-server', {

      dataToSaveString: undefined,
      serviceSaveVerb: undefined,

      dataToDeleteString: undefined,

      // --- Entity GET
      // --- ---------------------

      entityGet: function () {
        this.$.service_get.go();
      },


      // --- Entity Create
      // --- ---------------------

      createEmptyEntity: function () {
        return {
          _id: undefined,
          _version: undefined,
          _source: {}
        };
      },


      entityCreate: function () {
        var opt = {
          body: this.data._source
        };
        this.dataToSaveString = JSON.stringify(opt);
        console.log("************ entityCreate", this.data);
        console.log("************ entityCreate datastring", this.dataToSaveString);
        console.log("Request Create of ", opt);
        this.serviceSaveVerb = 'POST';
        this.$.service_save.go();
      },


      // --- Entity Update
      // --- ---------------------

      entityUpdate: function () {
        var opt = {
          version: this.data._version,
          body: {
            doc: this.data._source
          }
        };
        this.dataToSaveString = JSON.stringify(opt);
        console.log("Request Save of ", opt);
        this.serviceSaveVerb = 'PUT';
        this.$.service_save.go();
      },

      // --- Entity Delete
      // --- ---------------------
      entityDelete: function () {
        var opt = {
          version: this.data._version
        };
        this.dataToDeleteString = JSON.stringify(opt);
        console.log("Request Delete of ", opt);

        this.$.service_delete.go();
      },

      // --- Get Event
      // --- ---------------------

      handleGetResponse: function (event, detail, target) {
        var status = detail.xhr.status;
        var statusText = detail.xhr.statusText;
        // Fire Event
        this.fire("get-response", {
          response: detail.response,
          status: status,
          statusText: statusText
        });
      },

      handleGetError: function (event, detail, target) {
        // BUG ? detail.response as Text with status:JsonObj ? ==> Read from xhr
        console.log("Bug handleSaveError detail.response (Not JSON) : ", detail.response);
        var resp = JSON.parse(detail.xhr.response);
        var status = detail.xhr.status;
        var statusText = detail.xhr.statusText;
        // Fire Event
        this.fire("get-error", {
          response: resp,
          status: status,
          statusText: statusText
        });
      },

      // --- Save Event
      // --- ---------------------

      handleSaveResponse: function (event, detail, target)  {
        var status = detail.xhr.status;
        var statusText = detail.xhr.statusText;
        console.log("Save response", status, ":",  detail.response);
        // Fire Event
        this.fire("save-response", {
          response:  detail.response,
          status: status,
          statusText: statusText
        });
      },

      handleSaveError: function (event, detail, target) {
        // BUG ? detail.response as Text with status:JsonObj ? ==> Read from xhr
        console.log("Bug handleSaveError detail.response (Not JSON) : ", detail.response);
        var resp = JSON.parse(detail.xhr.response);
        var status = detail.xhr.status;
        var statusText = detail.xhr.statusText;
        // Fire Event
        this.fire("save-error", {
          response: resp,
          status: status,
          statusText: statusText
        });
      },

      // --- Delete Event
      // --- ---------------------

      handleDeleteResponse: function (event, detail, target)  {
        var status = detail.xhr.status;
        var statusText = detail.xhr.statusText;
        console.log("Delete response", status, ":",  detail.response);
        // Fire Event
        this.fire("delete-response", {
          response:  detail.response,
          status: status,
          statusText: statusText
        });
      },

      handleDeleteError: function (event, detail, target) {
        // BUG ? detail.response as Text with status:JsonObj ? ==> Read from xhr
        console.log("Bug handleSaveError detail.response (Not JSON) : ", detail.response);
        var resp = JSON.parse(detail.xhr.response);
        var status = detail.xhr.status;
        var statusText = detail.xhr.statusText;
        // Fire Event
        this.fire("delete-error", {
          response: resp,
          status: status,
          statusText: statusText
        });
      }


      // --- Others
      // --- ---------------------


    });

  </script>
</polymer-element>
